// Awareness Map JavaScript for Wesal
document.addEventListener('DOMContentLoaded', function() {
    initializeAwarenessMap();
    checkAuthenticationRequired();
});

let currentUser = null;
let awarenessLevels = [];
let currentLevel = 0;
let userProgress = {};

function initializeAwarenessMap() {
    currentUser = getCurrentUser();
    if (!currentUser) {
        window.location.href = 'login.html';
        return;
    }

    // Initialize awareness levels
    initializeAwarenessLevels();
    
    // Load user progress
    loadUserProgress();
    
    // Setup UI
    setupEventListeners();
    renderAwarenessMap();
    updateProgressIndicator();
    
    // Initialize logout functionality
    setupLogout();
}

function checkAuthenticationRequired() {
    if (!getCurrentUser()) {
        window.location.href = 'login.html';
    }
}

function initializeAwarenessLevels() {
    awarenessLevels = [
        {
            id: 1,
            name: 'ุงูุจุฏุงูุฉ - ุงูููุธุฉ ุงูุฃููู',
            description: 'ูู ูุฐุง ุงููุณุชูู ุชุจุฏุฃ ุฑุญูุฉ ุงููุนู ุงูุญููููุฉ. ุชุชุนูู ููููุฉ ููุงุญุธุฉ ุฃููุงุฑู ููุดุงุนุฑู ุฏูู ุงูุญูู ุนูููุง.',
            icon: '๐ฑ',
            color: 'from-green-400 to-blue-500',
            position: { top: '80%', left: '10%' },
            requirements: [
                'ุฅููุงู ุชูุฑูู ุงูุชููุณ ุงููุงุนู',
                'ููุงุฑุณุฉ ุงูุชุฃูู ููุฏุฉ 5 ุฏูุงุฆู ููููุงู ููุฏุฉ 3 ุฃูุงู',
                'ูุชุงุจุฉ ููุดูุฑ ุนู ุชุฌุฑุจุชู ุงูุฃููู'
            ],
            exercises: [
                {
                    title: 'ุชูุฑูู ุงูุชููุณ ุงููุงุนู',
                    description: 'ุงุฌูุณ ูู ููุงู ูุงุฏุฆ ูุงุบูุถ ุนูููู. ุฑูุฒ ุนูู ุฃููุงุณู ุงูุทุจูุนูุฉ ุฏูู ุชุบููุฑูุง. ูุงุญุธ ููู ูุฏุฎู ุงูููุงุก ูููู ูุฎุฑุฌ. ุฅุฐุง ุดุฑุฏ ุฐูููุ ุฃุนุฏู ุจูุทู ููุชููุณ.',
                    duration: '5 ุฏูุงุฆู',
                    steps: [
                        'ุงุฌูุณ ูู ูุถุนูุฉ ูุฑูุญุฉ',
                        'ุงุบูุถ ุนูููู ูุชููุณ ุทุจูุนูุงู',
                        'ุฑูุฒ ุนูู ุงูุดููู ูุงูุฒููุฑ',
                        'ูุงุญุธ ุงูุฃุญุงุณูุณ ูู ุฌุณุฏู',
                        'ุนูุฏูุง ูุดุฑุฏ ุงูุฐููุ ุฃุนุฏู ููุชููุณ'
                    ]
                }
            ],
            minScore: 0,
            maxScore: 30
        },
        {
            id: 2,
            name: 'ุงูุงุณุชุจุตุงุฑ - ููู ุงูุฐุงุช',
            description: 'ุชุทููุฑ ุงููุฏุฑุฉ ุนูู ููู ุฃููุงุท ุงูุชูููุฑ ูุงูุณููู ุงูุฏุงุฎููุฉุ ูุงูุจุฏุก ูู ุชุญุฏูุฏ ุงูุนูุงุฆู ุงูุฐูููุฉ.',
            icon: '๐',
            color: 'from-blue-500 to-purple-500',
            position: { top: '65%', left: '25%' },
            requirements: [
                'ุฅููุงู ุชูุฑูู ูุฑุงูุจุฉ ุงูุฃููุงุฑ',
                'ุชุญุฏูุฏ 3 ุฃููุงุท ุชูููุฑ ุณูุจูุฉ ุดุฎุตูุฉ',
                'ููุงุฑุณุฉ ุงูุชุฃูู ููุฏุฉ 10 ุฏูุงุฆู ููููุงู'
            ],
            exercises: [
                {
                    title: 'ุชูุฑูู ูุฑุงูุจุฉ ุงูุฃููุงุฑ',
                    description: 'ุงุฌูุณ ูู ุตูุช ูุฑุงูุจ ุฃููุงุฑู ููุง ูู ููุช ุชุฑุงูุจ ุงูุบููู ูู ุงูุณูุงุก. ูุง ุชุชุฏุฎู ุฃู ุชุญููุ ููุท ุฑุงูุจ ูุณุฌู.',
                    duration: '10 ุฏูุงุฆู',
                    steps: [
                        'ุงุชุฎุฐ ูุถุนูุฉ ุงูุชุฃูู',
                        'ุงุณูุญ ููุฃููุงุฑ ุจุงููุฑูุฑ',
                        'ุฑุงูุจ ุจุฏูู ุญูู',
                        'ุณุฌู ุงูุฃููุงุท ุงูุชู ุชูุงุญุธูุง',
                        'ุงุฎุชุชู ุจุชููุณ ุนููู'
                    ]
                }
            ],
            minScore: 31,
            maxScore: 60
        },
        {
            id: 3,
            name: 'ุงูุชุทููุฑ - ุชุญุฑูุฑ ุงูุนูุงุฆู',
            description: 'ุงูุนูู ุนูู ุชุญุฑูุฑ ุงูุนูุงุฆู ุงูุนุงุทููุฉ ูุงูุฐูููุฉ ุงููุฏููุฉ ุงูุชู ุชููุน ุงูููู ุงูุฑูุญู.',
            icon: '๐',
            color: 'from-purple-500 to-pink-500',
            position: { top: '50%', left: '40%' },
            requirements: [
                'ููุงุฑุณุฉ ุชูุฑูู ุงูุชุญุฑุฑ ุงูุนุงุทูู',
                'ูุชุงุจุฉ ุฑุณุงูุฉ ูุณุงูุญุฉ ููุฐุงุช',
                'ุฅููุงู ุฌูุณุฉ ุชุฃูู ุงูุชุทููุฑ'
            ],
            exercises: [
                {
                    title: 'ุชูุฑูู ุงูุชุญุฑุฑ ุงูุนุงุทูู',
                    description: 'ุชูููุฉ ูุชุญุฑูุฑ ุงููุดุงุนุฑ ุงูููุจูุชุฉ ูุงูุนูุงุฆู ุงูุนุงุทููุฉ ูู ุฎูุงู ุงูุชููุณ ูุงูุญุฑูุฉ ุงููุงุนูุฉ.',
                    duration: '15 ุฏูููุฉ',
                    steps: [
                        'ุชุญุฏูุฏ ุงููุดุงุนุฑ ุงูููุจูุชุฉ',
                        'ุงูุชููุณ ุงูุนููู ูู ููุทูุฉ ุงูุฃูู',
                        'ุงูุณูุงุญ ูููุดุงุนุฑ ุจุงูุฎุฑูุฌ',
                        'ุงูุญุฑูุฉ ุงูุชุนุจูุฑูุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ',
                        'ุงูุงูุชูุงุก ุจุชุฃููุฏุงุช ุฅูุฌุงุจูุฉ'
                    ]
                }
            ],
            minScore: 61,
            maxScore: 100
        },
        {
            id: 4,
            name: 'ุงูุชูุงุฒู - ุงูุณุฌุงู ุงูุทุงูุงุช',
            description: 'ุชุญููู ุงูุชูุงุฒู ุจูู ุฌููุน ุฌูุงูุจ ุงูุญูุงุฉ: ุงูุฌุณุฏูุฉุ ุงูุนูููุฉุ ุงูุนุงุทููุฉุ ูุงูุฑูุญูุฉ.',
            icon: 'โ๏ธ',
            color: 'from-pink-500 to-orange-400',
            position: { top: '35%', left: '55%' },
            requirements: [
                'ููุงุฑุณุฉ ุชูุฑูู ุชูุงุฒู ุงูุทุงูุงุช',
                'ุฅูุดุงุก ุฑูุชูู ูููู ูุชูุงุฒู',
                'ุฅููุงู ุชุฃูู ุงูุดุงูุฑุงุช ุงูุณุจุน'
            ],
            exercises: [
                {
                    title: 'ุชูุฑูู ุชูุงุฒู ุงูุทุงูุงุช',
                    description: 'ุชูุฑูู ุดุงูู ูุชูุณูู ูุชูุงุฒู ุงูุทุงูุงุช ูู ุงูุฌุณู ูู ุฎูุงู ุงูุชููุณ ูุงูุชุตูุฑ.',
                    duration: '20 ุฏูููุฉ',
                    steps: [
                        'ุงูุงุณุชููุงุก ูู ูุถุนูุฉ ูุฑูุญุฉ',
                        'ุงูุชููุณ ูู ูู ูุฑูุฒ ุทุงูุฉ',
                        'ุชุตูุฑ ุงูุถูุก ูุชุญุฑู ุนุจุฑ ุงูุฌุณู',
                        'ุชูุงุฒู ุงูุทุงูุงุช ุจุงูุชููุณ',
                        'ุฅุญูุงู ุงูุฅุบูุงู ุจุงูุงูุชูุงู'
                    ]
                }
            ],
            minScore: 101,
            maxScore: 140
        },
        {
            id: 5,
            name: 'ุงูุญููุฉ - ุงููุนุฑูุฉ ุงูุนูููุฉ',
            description: 'ุชุทููุฑ ุงูุญููุฉ ุงูุฏุงุฎููุฉ ูุงููุฏุฑุฉ ุนูู ุฑุคูุฉ ุงูุญูููุฉ ูุฑุงุก ุงูุฃููุงู ูุงูุฃุดูุงู ุงูุธุงูุฑูุฉ.',
            icon: '๐ฆ',
            color: 'from-orange-400 to-yellow-400',
            position: { top: '20%', left: '70%' },
            requirements: [
                'ุฏุฑุงุณุฉ ุงููุตูุต ุงูุฑูุญูุฉ ุงูุนูููุฉ',
                'ููุงุฑุณุฉ ุงูุชุฃูู ุงูุชุญูููู',
                'ูุดุงุฑูุฉ ุงูุญููุฉ ูุน ุงูุขุฎุฑูู'
            ],
            exercises: [
                {
                    title: 'ุชุฃูู ุงูุญููุฉ ุงูุฏุงุฎููุฉ',
                    description: 'ุชูุฑูู ูููุตูู ุฅูู ูุตุฏุฑ ุงูุญููุฉ ุงูุฏุงุฎููุฉ ูุงูุญุตูู ุนูู ุฅุฑุดุงุฏุงุช ูู ุงูุฐุงุช ุงูุนููุง.',
                    duration: '25 ุฏูููุฉ',
                    steps: [
                        'ุฏุฎูู ูู ุญุงูุฉ ุชุฃูู ุนููู',
                        'ุทุฑุญ ุณุคุงู ุนูู ุงูุฐุงุช ุงูุนููุง',
                        'ุงูุงุณุชูุงุน ููุฅุฌุงุจุงุช ุงูุฏุงุฎููุฉ',
                        'ุชุณุฌูู ุงูุฑุคู ูุงูุฅููุงูุงุช',
                        'ุชุทุจูู ุงูุญููุฉ ูู ุงูุญูุงุฉ'
                    ]
                }
            ],
            minScore: 141,
            maxScore: 180
        },
        {
            id: 6,
            name: 'ุงูุชูููุฑ - ุงููุนู ุงููุงูู',
            description: 'ุงููุตูู ุฅูู ุญุงูุฉ ุงููุนู ุงููุงูู ูุงูุงุชุญุงุฏ ูุน ุงููุฌูุฏ. ูุฐุง ูู ุงููุฏู ุงูุฃุณูู ููุฑุญูุฉ ุงูุฑูุญูุฉ.',
            icon: 'โจ',
            color: 'from-yellow-400 to-white',
            position: { top: '5%', left: '85%' },
            requirements: [
                'ุงูุนูุด ูู ุญุงูุฉ ูุนู ูุณุชูุฑ',
                'ุฎุฏูุฉ ุงูุขุฎุฑูู ูู ููุงู ุงููุญุจุฉ',
                'ุชุฌุณูุฏ ุงูุญููุฉ ูู ูู ูุญุธุฉ'
            ],
            exercises: [
                {
                    title: 'ุชุฃูู ุงููุญุฏุฉ ุงููุงููุฉ',
                    description: 'ุงูููุงุฑุณุฉ ุงูุฃุณูู ููุชุฃูู ุงูุชู ุชุคุฏู ุฅูู ุงุฎุชุจุงุฑ ุงููุญุฏุฉ ูุน ูู ูุง ูู ููุฌูุฏ.',
                    duration: '30+ ุฏูููุฉ',
                    steps: [
                        'ุชุฌุงูุฒ ุญุฏูุฏ ุงูุฐุงุช ุงูุดุฎุตูุฉ',
                        'ุงูุฐูุจุงู ูู ุงููุนู ุงููุทูู',
                        'ุงุฎุชุจุงุฑ ุงููุญุฏุฉ ูุน ุงููุฌูุฏ',
                        'ุงูุนูุฏุฉ ุจุงูุญููุฉ ูุงููุญุจุฉ',
                        'ุชุฌุณูุฏ ุงูููุฑ ูู ุงูุนุงูู'
                    ]
                }
            ],
            minScore: 181,
            maxScore: 200
        }
    ];
}

function loadUserProgress() {
    // Load progress from localStorage or initialize
    const storedProgress = localStorage.getItem('wesal_user_progress');
    if (storedProgress) {
        userProgress = JSON.parse(storedProgress);
    } else {
        userProgress = {
            currentLevel: 1,
            completedLevels: [],
            exercisesCompleted: [],
            totalScore: currentUser.awarenesTone || 0
        };
        saveUserProgress();
    }

    // Determine current level based on score
    currentLevel = awarenessLevels.find(level => 
        userProgress.totalScore >= level.minScore && userProgress.totalScore <= level.maxScore
    )?.id || 1;
}

function saveUserProgress() {
    localStorage.setItem('wesal_user_progress', JSON.stringify(userProgress));
    
    // Also update user's awareness tone
    currentUser.awarenesTone = userProgress.totalScore;
    localStorage.setItem('wesal_user', JSON.stringify(currentUser));
}

function setupEventListeners() {
    // Exercise modal buttons
    const closeExerciseModal = document.getElementById('close-exercise-modal');
    const completeExercise = document.getElementById('complete-exercise');
    const skipExercise = document.getElementById('skip-exercise');

    if (closeExerciseModal) closeExerciseModal.addEventListener('click', closeExerciseModal);
    if (completeExercise) completeExercise.addEventListener('click', handleCompleteExercise);
    if (skipExercise) skipExercise.addEventListener('click', closeExerciseModal);

    // Level detail modal buttons
    const closeLevelModal = document.getElementById('close-level-modal');
    const startLevel = document.getElementById('start-level');

    if (closeLevelModal) closeLevelModal.addEventListener('click', closeLevelDetailModal);
    if (startLevel) startLevel.addEventListener('click', handleStartLevel);

    // Logout functionality
    setupLogout();
}

function setupLogout() {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('wesal_user');
            window.location.href = 'index.html';
        });
    }
}

function renderAwarenessMap() {
    const levelsContainer = document.getElementById('awareness-levels');
    if (!levelsContainer) return;

    levelsContainer.innerHTML = awarenessLevels.map((level, index) => {
        const isCompleted = userProgress.completedLevels.includes(level.id);
        const isCurrent = currentLevel === level.id;
        const isAvailable = level.id <= currentLevel || isCompleted;
        
        return `
            <div class="absolute transform -translate-x-1/2 -translate-y-1/2" 
                 style="top: ${level.position.top}; left: ${level.position.left};">
                <div class="awareness-level-node ${isAvailable ? 'available' : 'locked'} ${isCurrent ? 'current' : ''} ${isCompleted ? 'completed' : ''}"
                     data-level-id="${level.id}"
                     onclick="handleLevelClick(${level.id})">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br ${level.color} flex items-center justify-center text-white shadow-lg cursor-pointer transition-all duration-300 hover:scale-110 ${!isAvailable ? 'opacity-50 cursor-not-allowed' : ''}">
                        <span class="text-2xl">${level.icon}</span>
                    </div>
                    <div class="mt-3 text-center">
                        <div class="font-bold text-purple-900 text-sm mb-1">${level.name.split(' - ')[0]}</div>
                        <div class="text-purple-600 text-xs">${level.name.split(' - ')[1]}</div>
                        ${isCompleted ? '<div class="text-green-600 text-xs mt-1">โ ููุชูู</div>' : ''}
                        ${isCurrent ? '<div class="text-orange-600 text-xs mt-1">โ ูููุนู ุงูุญุงูู</div>' : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateProgressIndicator() {
    const currentLevelName = document.getElementById('current-level-name');
    const overallProgress = document.getElementById('overall-progress');

    if (currentLevelName) {
        const level = awarenessLevels.find(l => l.id === currentLevel);
        currentLevelName.textContent = level ? level.name : 'ุงููุณุชูู ุงูุฃูู';
    }

    if (overallProgress) {
        const progressPercent = (userProgress.totalScore / 200) * 100;
        overallProgress.style.width = `${Math.min(progressPercent, 100)}%`;
    }
}

function handleLevelClick(levelId) {
    const level = awarenessLevels.find(l => l.id === levelId);
    if (!level) return;

    const isAvailable = levelId <= currentLevel || userProgress.completedLevels.includes(levelId);
    if (!isAvailable) {
        showNotification('ูุฌุจ ุฅููุงู ุงููุณุชููุงุช ุงูุณุงุจูุฉ ุฃููุงู', 'error');
        return;
    }

    openLevelDetailModal(level);
}

function openLevelDetailModal(level) {
    const modal = document.getElementById('level-modal');
    const levelTitle = document.getElementById('level-title');
    const levelDescription = document.getElementById('level-description');
    const requirementsList = document.getElementById('requirements-list');

    if (levelTitle) levelTitle.textContent = level.name;
    if (levelDescription) levelDescription.textContent = level.description;
    
    if (requirementsList) {
        requirementsList.innerHTML = level.requirements.map(req => 
            `<li class="text-purple-600">${req}</li>`
        ).join('');
    }

    modal.classList.remove('hidden');
}

function closeLevelDetailModal() {
    const modal = document.getElementById('level-modal');
    modal.classList.add('hidden');
}

function handleStartLevel() {
    closeLevelDetailModal();
    const level = awarenessLevels.find(l => l.id === currentLevel);
    if (level && level.exercises.length > 0) {
        openExerciseModal(level.exercises[0]);
    }
}

function openExerciseModal(exercise) {
    const modal = document.getElementById('exercise-modal');
    const exerciseTitle = document.getElementById('exercise-title');
    const exerciseContent = document.getElementById('exercise-content');

    if (exerciseTitle) exerciseTitle.textContent = exercise.title;
    
    if (exerciseContent) {
        exerciseContent.innerHTML = `
            <div class="space-y-4">
                <div class="bg-purple-50 rounded-xl p-4">
                    <h4 class="font-bold text-purple-900 mb-2">ุงููุตู:</h4>
                    <p class="text-purple-700">${exercise.description}</p>
                </div>
                
                <div class="bg-blue-50 rounded-xl p-4">
                    <h4 class="font-bold text-blue-900 mb-2">ุงููุฏุฉ ุงูููุชุฑุญุฉ: ${exercise.duration}</h4>
                </div>
                
                <div class="bg-green-50 rounded-xl p-4">
                    <h4 class="font-bold text-green-900 mb-3">ุฎุทูุงุช ุงูุชูุฑูู:</h4>
                    <ol class="list-decimal list-inside space-y-2">
                        ${exercise.steps.map(step => `<li class="text-green-800">${step}</li>`).join('')}
                    </ol>
                </div>
                
                <div class="bg-yellow-50 rounded-xl p-4">
                    <h4 class="font-bold text-yellow-900 mb-2">๐ก ูุตูุญุฉ:</h4>
                    <p class="text-yellow-800">ุฎุฐ ููุชู ููุง ุชุณุชุนุฌู. ูู ุชุฌุฑุจุฉ ูุฑูุฏุฉ ููููุฉ ูู ุฑุญูุชู.</p>
                </div>
            </div>
        `;
    }

    modal.classList.remove('hidden');
}

function closeExerciseModal() {
    const modal = document.getElementById('exercise-modal');
    modal.classList.add('hidden');
}

function handleCompleteExercise() {
    // Award points for completing exercise
    const pointsEarned = 10;
    userProgress.totalScore += pointsEarned;
    
    // Check if user advanced to next level
    const newLevel = awarenessLevels.find(level => 
        userProgress.totalScore >= level.minScore && userProgress.totalScore <= level.maxScore
    )?.id || currentLevel;

    if (newLevel > currentLevel) {
        currentLevel = newLevel;
        userProgress.completedLevels.push(currentLevel - 1);
        showNotification(`๐ ุชูุงูููุง! ูุตูุช ูููุณุชูู ${currentLevel}`, 'success');
    } else {
        showNotification(`โจ ููุชุงุฒ! ูุณุจุช ${pointsEarned} ููุทุฉ ูุนู`, 'success');
    }

    // Save progress
    saveUserProgress();
    
    // Update UI
    updateProgressIndicator();
    renderAwarenessMap();
    
    closeExerciseModal();
}

// Utility functions
function getCurrentUser() {
    try {
        const userStr = localStorage.getItem('wesal_user');
        return userStr ? JSON.parse(userStr) : null;
    } catch (error) {
        console.error('Error getting current user:', error);
        return null;
    }
}

function showNotification(message, type = 'info') {
    if (window.WesalUtils && window.WesalUtils.showNotification) {
        window.WesalUtils.showNotification(message, type);
    } else {
        console.log(message);
    }
}

// Add CSS for level nodes
const style = document.createElement('style');
style.textContent = `
    .awareness-level-node.available {
        transition: all 0.3s ease;
    }
    
    .awareness-level-node.available:hover {
        transform: translateY(-5px);
    }
    
    .awareness-level-node.current::after {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        border: 3px solid #F59E0B;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .awareness-level-node.completed::before {
        content: 'โ';
        position: absolute;
        top: -10px;
        right: -10px;
        background: #10B981;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        z-index: 10;
    }
    
    @keyframes pulse {
        0% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(1.1);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }
`;
document.head.appendChild(style);
